<!DOCTYPE html>
<html lang="zh">
<head>
  <meta charset="UTF-8" />
  <title>相關博文</title>
</head>
<body>

  <div id="related-articles">
    <ul id="articles-list"></ul>
  </div>

  <script>
    const params = new URLSearchParams(window.location.search);
    const rawTags = params.get('tags'); // 讀取當前頁面傳遞的標籤參數
    const excludeLink = params.get('exclude'); // 用來排除當前文章的連結

    if (!rawTags) {
      document.getElementById('articles-list').innerHTML = '<li>未提供關鍵詞參數。</li>';
    } else {
      const tags = rawTags.split(',').map(tag => tag.trim()); // 分割並清理標籤

      fetch('blog-articles.json') // 載入 JSON 文件
        .then(res => res.json())
        .then(articles => {
          const seen = new Set(); // 用來避免顯示重複的文章
          const finalArticles = [];

          // 優先從每個標籤中選取 1-2 篇相關文章
          tags.forEach(tag => {
            const matching = articles.filter(article =>
              article.tag.includes(tag) &&  // 使用正確的 'tag' 欄位
              article.link !== excludeLink && // 排除當前文章
              !seen.has(article.link)  // 防止顯示重複的文章
            );

            // 隨機排序增加多樣性
            shuffle(matching);

            for (let i = 0; i < Math.min(2, matching.length); i++) {
              finalArticles.push(matching[i]);
              seen.add(matching[i].link);
              if (finalArticles.length >= 5) break; // 如果已經找到五篇文章，停止搜尋
            }
          });

          // 如果仍然不到五篇，再從其他文章中補充
          if (finalArticles.length < 5) {
            const remaining = articles.filter(article =>
              tags.some(tag => article.tag.includes(tag)) &&  // 使用正確的 'tag' 欄位
              article.link !== excludeLink && 
              !seen.has(article.link)
            );

            shuffle(remaining);
            for (let article of remaining) {
              finalArticles.push(article);
              seen.add(article.link);
              if (finalArticles.length >= 5) break; // 停止搜尋
            }
          }

          const list = document.getElementById('articles-list');
          if (finalArticles.length > 0) {
            finalArticles.forEach(article => {
              const li = document.createElement('li');
              li.innerHTML = `<a href="${article.link}" target="_parent">${article.title}</a>`;
              list.appendChild(li);
            });
          } else {
            list.innerHTML = '<li>這個主題還沒有相關文章。如果你感興趣，去留言區留言吧。或是<a href="/">先回主頁逛逛</a>。</li>';
          }
        });

      // 隨機排序函數
      function shuffle(array) {
        for (let i = array.length - 1; i > 0; i--) {
          const j = Math.floor(Math.random() * (i + 1));
          [array[i], array[j]] = [array[j], array[i]]; // 交換元素
        }
      }
    }
  </script>

</body>
</html>

