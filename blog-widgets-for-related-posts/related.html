<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>相關博文</title>
  <link rel="stylesheet" href="related.css">
</head>
<body>
  <div class="related-articles-container">
    <h3 class="related-title">你可能也會喜歡</h3>
    <ul class="articles-list" id="articles-list"></ul>
  </div>

  <script>
    document.addEventListener('DOMContentLoaded', function() {
      const params = new URLSearchParams(window.location.search);
      const rawTags = params.get('tags');
      const excludeLink = params.get('exclude');

      if (!rawTags) {
        document.getElementById('articles-list').innerHTML = 
          '<li class="no-results">未提供關鍵詞參數。</li>';
        return;
      }

      const tags = rawTags.split(',').map(tag => tag.trim());
      const listElement = document.getElementById('articles-list');

      fetch('blog-articles.json')
        .then(response => {
          if (!response.ok) {
            throw new Error('網路回應不正常');
          }
          return response.json();
        })
        .then(articles => {
          const relatedArticles = findRelatedArticles(articles, tags, excludeLink);
          displayArticles(relatedArticles, listElement);
        })
        .catch(error => {
          console.error('載入相關文章失敗:', error);
          listElement.innerHTML = 
            '<li class="no-results">暫時無法載入相關文章，請稍後再試。</li>';
        });

      function findRelatedArticles(articles, tags, excludeLink) {
        const seen = new Set();
        const finalArticles = [];

        // 優先從每個標籤中選取1-2篇相關文章
        tags.forEach(tag => {
          const matching = articles.filter(article =>
            article.tag.includes(tag) &&
            article.link !== excludeLink &&
            !seen.has(article.link)
          );

          shuffleArray(matching);

          for (let i = 0; i < Math.min(2, matching.length); i++) {
            if (finalArticles.length >= 5) break;
            finalArticles.push(matching[i]);
            seen.add(matching[i].link);
          }
        });

        // 如果仍然不到五篇，再從其他文章中補充
        if (finalArticles.length < 5) {
          const remaining = articles.filter(article =>
            tags.some(tag => article.tag.includes(tag)) &&
            article.link !== excludeLink &&
            !seen.has(article.link)
          );

          shuffleArray(remaining);
          for (let article of remaining) {
            if (finalArticles.length >= 5) break;
            finalArticles.push(article);
            seen.add(article.link);
          }
        }

        return finalArticles;
      }

      function displayArticles(articles, listElement) {
        if (articles.length === 0) {
          listElement.innerHTML = `
            <li class="no-results">
              這個主題還沒有相關文章。如果你感興趣，去留言區留言吧。
              或是<a href="/" target="_parent">先回主頁逛逛</a>。
            </li>`;
          return;
        }

        listElement.innerHTML = articles.map(article => `
          <li class="article-item">
            <a href="${article.link}" target="_parent" class="article-link">
              ${article.title}
            </a>
          </li>
        `).join('');
      }

      function shuffleArray(array) {
        for (let i = array.length - 1; i > 0; i--) {
          const j = Math.floor(Math.random() * (i + 1));
          [array[i], array[j]] = [array[j], array[i]];
        }
        return array;
      }
    });
  </script>
</body>
</html>